<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Gift Registry</title>
  <!-- Google Fonts ‚Äî Partiful-inspired playful type -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'DM Sans', -apple-system, sans-serif;
      background: linear-gradient(145deg, #fdf4f0 0%, #f0e6ff 35%, #e8f4fd 65%, #fef4e8 100%);
      background-attachment: fixed;
      min-height: 100vh;
    }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 3px; }
    ::selection { background: #e8c8ff; }
    /* Google Places autocomplete dropdown styling */
    .pac-container {
      font-family: 'DM Sans', -apple-system, sans-serif;
      border-radius: 16px;
      border: 1px solid rgba(124,58,237,0.12);
      box-shadow: 0 8px 32px rgba(124,58,237,0.12);
      margin-top: 4px;
      overflow: hidden;
    }
    .pac-item {
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      border-top: 1px solid rgba(0,0,0,0.04);
    }
    .pac-item:first-child { border-top: none; }
    .pac-item:hover, .pac-item-selected {
      background: #f3e8ff;
    }
    .pac-item-query {
      font-weight: 600;
      color: #1a1a2e;
    }
    .pac-icon { display: none; }
    .pac-matched { color: #7c3aed; font-weight: 700; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <!-- Material UI -->
  <script src="https://unpkg.com/@mui/material@5/umd/material-ui.production.min.js" crossorigin></script>

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-type="module">
    const {
      AppBar, Toolbar, Typography, Container, Grid, Card, CardMedia, CardContent,
      CardActions, Button, TextField, Box, Paper, Chip, Rating, Dialog, DialogTitle,
      DialogContent, DialogActions, Snackbar, Alert, IconButton, InputAdornment,
      Tabs, Tab, Avatar, List, ListItem, ListItemAvatar, ListItemText, Divider,
      CircularProgress, Fab, Badge, Select, MenuItem, FormControl, InputLabel
    } = MaterialUI;

    const { useState, useEffect } = React;

    // US States for dropdown
    const US_STATES = [
      'Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut',
      'Delaware', 'Florida', 'Georgia', 'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa',
      'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland', 'Massachusetts', 'Michigan',
      'Minnesota', 'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire',
      'New Jersey', 'New Mexico', 'New York', 'North Carolina', 'North Dakota', 'Ohio',
      'Oklahoma', 'Oregon', 'Pennsylvania', 'Rhode Island', 'South Carolina', 'South Dakota',
      'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia', 'Washington', 'West Virginia',
      'Wisconsin', 'Wyoming'
    ];

    // State abbreviations for Shopify
    const STATE_CODES = {
      'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
      'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
      'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
      'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
      'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
      'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
      'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
      'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
      'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
      'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY'
    };

    // Phone number validation and formatting
    const formatPhoneNumber = (value) => {
      const digits = value.replace(/\D/g, '');
      if (digits.length <= 3) return digits;
      if (digits.length <= 6) return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
      return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6, 10)}`;
    };

    const validatePhone = (phone) => {
      const digits = phone.replace(/\D/g, '');
      if (!digits) return '';
      if (digits.length < 10) return 'Phone number must be at least 10 digits';
      if (digits.length > 15) return 'Phone number is too long';
      if (digits.length === 10 && digits[0] === '0') return 'Invalid area code';
      if (digits.length === 10 && digits[0] === '1') return 'Do not include country code';
      return '';
    };

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Google Places Autocomplete loader
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let googlePlacesLoaded = false;
    let googlePlacesLoadPromise = null;

    function loadGooglePlaces() {
      if (googlePlacesLoaded) return Promise.resolve();
      if (googlePlacesLoadPromise) return googlePlacesLoadPromise;

      googlePlacesLoadPromise = fetch('/api/config')
        .then(r => r.json())
        .then(config => {
          const key = config.googlePlacesApiKey;
          if (!key) {
            console.warn('[Places] No Google Places API key configured');
            return;
          }
          return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${key}&libraries=places`;
            script.async = true;
            script.onload = () => { googlePlacesLoaded = true; resolve(); };
            script.onerror = () => reject(new Error('Failed to load Google Places'));
            document.head.appendChild(script);
          });
        });
      return googlePlacesLoadPromise;
    }

    // Reverse-lookup for state abbreviation ‚Üí full name
    const STATE_NAMES = Object.fromEntries(
      Object.entries(STATE_CODES).map(([name, code]) => [code, name])
    );

    // Parse a Google Place result into address components
    function parsePlaceResult(place) {
      const components = {};
      (place.address_components || []).forEach(c => {
        c.types.forEach(type => { components[type] = c; });
      });

      const streetNumber = components.street_number?.long_name || '';
      const route = components.route?.short_name || '';
      const address1 = `${streetNumber} ${route}`.trim();
      const subpremise = components.subpremise?.long_name || '';
      const city = components.locality?.long_name ||
                   components.sublocality_level_1?.long_name ||
                   components.administrative_area_level_2?.long_name || '';
      const stateCode = components.administrative_area_level_1?.short_name || '';
      const stateName = STATE_NAMES[stateCode] || stateCode;
      const postalCode = components.postal_code?.long_name || '';

      return {
        address1: address1.substring(0, 35),
        address2: subpremise ? `#${subpremise}` : '',
        city,
        state: stateName,
        postalCode
      };
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // AddressAutocomplete Component
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function AddressAutocomplete({ value, onChange, onPlaceSelected }) {
      const inputRef = React.useRef(null);
      const autocompleteRef = React.useRef(null);
      const [placesAvailable, setPlacesAvailable] = React.useState(false);

      React.useEffect(() => {
        loadGooglePlaces().then(() => {
          if (!window.google?.maps?.places || !inputRef.current) return;
          setPlacesAvailable(true);

          const ac = new window.google.maps.places.Autocomplete(inputRef.current, {
            types: ['address'],
            componentRestrictions: { country: ['us', 'ca', 'gb'] },
            fields: ['address_components', 'formatted_address']
          });

          ac.addListener('place_changed', () => {
            const place = ac.getPlace();
            if (!place.address_components) return;
            const parsed = parsePlaceResult(place);
            if (onPlaceSelected) onPlaceSelected(parsed);
          });

          autocompleteRef.current = ac;
        }).catch(err => {
          console.warn('[Places] Could not load:', err.message);
        });

        return () => {
          if (autocompleteRef.current) {
            window.google?.maps?.event?.clearInstanceListeners(autocompleteRef.current);
          }
        };
      }, []);

      return (
        <TextField
          fullWidth
          label="Address (35 character limit)"
          variant="outlined"
          sx={{ mb: 2 }}
          inputProps={{ maxLength: 35, ref: inputRef }}
          value={value}
          onChange={(e) => onChange(e.target.value)}
          placeholder={placesAvailable ? 'Start typing to search...' : ''}
          InputProps={{
            endAdornment: placesAvailable ? (
              <InputAdornment position="end">
                <span className="material-icons" style={{ fontSize: 18, color: '#7c3aed', opacity: 0.6 }}>location_on</span>
              </InputAdornment>
            ) : null
          }}
        />
      );
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // App Component
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function App() {
      const [tab, setTab] = useState(0);
      const [products, setProducts] = useState([]);
      const [loading, setLoading] = useState(true);
      const [search, setSearch] = useState('');
      const [source, setSource] = useState('');

      // Cart state ‚Äî pre-loaded with known working test product
      const [cart, setCart] = useState([
        {
          id: 'art-of-potato-mr-potato-head',
          title: 'Mr Potato Head',
          price: '14.95',
          currency: 'USD',
          image: 'https://cdn.shopify.com/s/files/1/0053/8342/2008/products/GUEST_4cf448b0-952c-4b1e-a49f-aff5591c37a7.jpg?v=1557862066',
          merchant: 'Art of Potato',
          shopDomain: 'art-of-potato.myshopify.com',
          variantId: 'gid://shopify/ProductVariant/19509261107256',
          quantity: 1
        }
      ]);
      const [cartOpen, setCartOpen] = useState(false);

      // Group state
      const [group, setGroup] = useState(null);
      const [leadForm, setLeadForm] = useState({ firstName: '', lastName: '', email: '', phone: '' });
      const [leadPhoneError, setLeadPhoneError] = useState('');
      const [memberForm, setMemberForm] = useState({ firstName: '', lastName: '', email: '', phone: '' });
      const [phoneError, setPhoneError] = useState('');
      const [recipientForm, setRecipientForm] = useState({
        country: 'United States',
        firstName: '',
        lastName: '',
        phone: '',
        address1: '',
        address2: '',
        city: '',
        state: '',
        postalCode: ''
      });
      const [recipientPhoneError, setRecipientPhoneError] = useState('');

      // Dialogs & alerts
      const [checkoutLoading, setCheckoutLoading] = useState(false);
      const [checkoutResponse, setCheckoutResponse] = useState(null); // MCP response modal
      const [snackbar, setSnackbar] = useState({ open: false, message: '', severity: 'success' });

      // Embedded Checkout Protocol (ECP)
      const [embeddedCheckout, setEmbeddedCheckout] = useState(null); // { continueUrl, recipient, productTitle }
      const [orderConfirmation, setOrderConfirmation] = useState(null); // { orderId, checkout }

      // Load products
      useEffect(() => {
        loadProducts();
      }, []);

      const loadProducts = async (query = '') => {
        setLoading(true);
        try {
          const params = new URLSearchParams();
          if (query) params.set('q', query);
          const res = await fetch('/api/products?' + params.toString());
          const data = await res.json();
          setProducts(data.products || []);
          setSource(data.source || '');
        } catch (err) {
          console.error(err);
        }
        setLoading(false);
      };

      const handleSearch = (e) => {
        const q = e.target.value;
        setSearch(q);
        clearTimeout(window.searchTimeout);
        window.searchTimeout = setTimeout(() => loadProducts(q), 400);
      };

      const createGroup = async () => {
        const res = await fetch('/api/groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(leadForm)
        });
        const data = await res.json();
        if (data.group) {
          setGroup(data.group);
          setSnackbar({ open: true, message: 'Group created!', severity: 'success' });
          setTab(1);
        } else {
          setSnackbar({ open: true, message: data.error || 'Error', severity: 'error' });
        }
      };

      const addMember = async () => {
        const res = await fetch(`/api/groups/${group.id}/members`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(memberForm)
        });
        const data = await res.json();
        if (data.member) {
          const groupRes = await fetch(`/api/groups/${group.id}`);
          const groupData = await groupRes.json();
          setGroup(groupData.group);
          setMemberForm({ firstName: '', lastName: '', email: '', phone: '' });
          setPhoneError('');
          setSnackbar({ open: true, message: 'Member added!', severity: 'success' });
        }
      };

      const setRecipient = async () => {
        const res = await fetch(`/api/groups/${group.id}/recipient`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...recipientForm,
            provinceCode: STATE_CODES[recipientForm.state] || recipientForm.state
          })
        });
        const data = await res.json();
        if (data.recipient) {
          setGroup({ ...group, recipient: data.recipient });
          setSnackbar({ open: true, message: 'Recipient set!', severity: 'success' });
          setTab(2);
        }
      };

      // Cart functions
      const addToCart = (product) => {
        const existing = cart.find(item => item.id === product.id);
        if (existing) {
          setCart(cart.map(item =>
            item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item
          ));
        } else {
          setCart([...cart, { ...product, quantity: 1 }]);
        }
        setSnackbar({ open: true, message: `${product.title} added to cart`, severity: 'success' });
      };

      const updateQuantity = (productId, delta) => {
        setCart(cart.map(item => {
          if (item.id === productId) {
            const newQty = item.quantity + delta;
            return newQty > 0 ? { ...item, quantity: newQty } : item;
          }
          return item;
        }).filter(item => item.quantity > 0));
      };

      const removeFromCart = (productId) => {
        setCart(cart.filter(item => item.id !== productId));
      };

      const cartTotal = cart.reduce((sum, item) => sum + (parseFloat(item.price) || 0) * item.quantity, 0);
      const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);

      // Checkout via MCP - creates checkout with group lead email + recipient shipping address
      const checkoutItem = async (item) => {
        if (!group) {
          setSnackbar({ open: true, message: 'Create a group first', severity: 'warning' });
          setCartOpen(false);
          setTab(0);
          return;
        }
        if (!group.recipient) {
          setSnackbar({ open: true, message: 'Set a recipient first', severity: 'warning' });
          setCartOpen(false);
          setTab(1);
          return;
        }

        // Check if product has variantId for MCP checkout
        if (!item.variantId) {
          setSnackbar({ open: true, message: 'Checkout unavailable - no variant ID for this product', severity: 'error' });
          return;
        }

        setCheckoutLoading(true);
        try {
          const res = await fetch('/api/create-checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              groupId: group.id,
              variantId: item.variantId,
              quantity: item.quantity,
              shopDomain: item.shopDomain
            })
          });
          const data = await res.json();

          if (data.success && data.checkoutUrl) {
            // Always open embedded checkout with the continue URL
            setCartOpen(false);
            setEmbeddedCheckout({
              continueUrl: data.checkoutUrl,
              recipient: group.recipient,
              productTitle: item.title,
              productPrice: item.price,
              quantity: item.quantity,
              checkoutId: data.checkoutId,
              status: data.status
            });
            setSnackbar({ open: true, message: 'Checkout created ‚Äî opening embedded checkout...', severity: 'info' });
          } else {
            // No continue URL ‚Äî show the raw response for debugging
            setCheckoutResponse({
              ...data,
              productTitle: item.title,
              productPrice: item.price,
              quantity: item.quantity
            });
          }
        } catch (err) {
          console.error('Checkout error:', err);
          setCheckoutResponse({
            success: false,
            error: err.message,
            productTitle: item.title
          });
        }
        setCheckoutLoading(false);
      };

      return (
        <Box sx={{ minHeight: '100vh' }}>
          {/* App Bar ‚Äî Partiful-style glassmorphism */}
          <AppBar position="sticky" elevation={0} sx={{
            bgcolor: 'rgba(255,255,255,0.72)',
            backdropFilter: 'blur(20px)',
            WebkitBackdropFilter: 'blur(20px)',
            borderBottom: '1px solid rgba(0,0,0,0.06)',
            color: '#1a1a2e'
          }}>
            <Toolbar sx={{ py: 0.5 }}>
              <Typography variant="h5" sx={{
                flexGrow: 1,
                fontFamily: "'Space Grotesk', sans-serif",
                fontWeight: 700,
                background: 'linear-gradient(135deg, #7c3aed, #db2777, #f59e0b)',
                WebkitBackgroundClip: 'text',
                WebkitTextFillColor: 'transparent'
              }}>üéÅ Gift Registry</Typography>
              {group && (
                <Chip
                  avatar={<Avatar sx={{ bgcolor: '#7c3aed !important', fontWeight: 700 }}>{group.lead.firstName[0]}</Avatar>}
                  label={`Group ${group.id}`}
                  sx={{ bgcolor: '#f3e8ff', color: '#7c3aed', fontWeight: 600, borderRadius: 99, mr: 1 }}
                />
              )}
              <IconButton onClick={() => setCartOpen(true)} sx={{
                bgcolor: cartCount > 0 ? '#fef3c7' : 'transparent',
                '&:hover': { bgcolor: '#fde68a' },
                borderRadius: 99
              }}>
                <Badge badgeContent={cartCount} sx={{ '& .MuiBadge-badge': { bgcolor: '#db2777', color: 'white', fontWeight: 700 } }}>
                  <span className="material-icons" style={{ color: '#1a1a2e' }}>shopping_bag</span>
                </Badge>
              </IconButton>
            </Toolbar>
            <Box sx={{ display: 'flex', justifyContent: 'center', pb: 1.5, gap: 1 }}>
              {[{ label: 'üë• Group', idx: 0, disabled: false },
                { label: 'üéâ Members', idx: 1, disabled: !group },
                { label: 'üõçÔ∏è Gifts', idx: 2, disabled: false }].map(t => (
                <Button key={t.idx}
                  disabled={t.disabled}
                  onClick={() => setTab(t.idx)}
                  sx={{
                    borderRadius: 99, px: 2.5, py: 0.8,
                    fontFamily: "'DM Sans', sans-serif",
                    fontWeight: 600, fontSize: '0.9rem',
                    textTransform: 'none',
                    bgcolor: tab === t.idx ? '#7c3aed' : 'rgba(124,58,237,0.08)',
                    color: tab === t.idx ? 'white' : '#7c3aed',
                    '&:hover': { bgcolor: tab === t.idx ? '#6d28d9' : 'rgba(124,58,237,0.15)' },
                    '&.Mui-disabled': { opacity: 0.4 },
                    transition: 'all 0.2s ease'
                  }}
                >{t.label}</Button>
              ))}
            </Box>
          </AppBar>

          <Container maxWidth="lg" sx={{ py: 4 }}>
            {/* Tab 0: Create Group */}
            {tab === 0 && (
              <Paper sx={{
                p: 4, maxWidth: 480, mx: 'auto',
                borderRadius: 5,
                border: '1px solid rgba(124,58,237,0.1)',
                boxShadow: '0 8px 32px rgba(124,58,237,0.08)',
                bgcolor: 'rgba(255,255,255,0.85)',
                backdropFilter: 'blur(10px)'
              }}>
                <Typography variant="h4" sx={{
                  fontFamily: "'Space Grotesk', sans-serif",
                  fontWeight: 700, mb: 0.5, textAlign: 'center'
                }}>üëã Hey there!</Typography>
                <Typography variant="body1" color="text.secondary" sx={{ mb: 3, textAlign: 'center', lineHeight: 1.6 }}>
                  You're organizing a group gift. Let's start with your info ‚Äî order confirmations go to your email.
                </Typography>
                <TextField
                  fullWidth label="First Name" variant="outlined" sx={{ mb: 2 }}
                  value={leadForm.firstName}
                  onChange={(e) => setLeadForm({ ...leadForm, firstName: e.target.value })}
                />
                <TextField
                  fullWidth label="Last Name" variant="outlined" sx={{ mb: 2 }}
                  value={leadForm.lastName}
                  onChange={(e) => setLeadForm({ ...leadForm, lastName: e.target.value })}
                />
                <TextField
                  fullWidth label="Email" type="email" variant="outlined" sx={{ mb: 2 }}
                  value={leadForm.email}
                  onChange={(e) => setLeadForm({ ...leadForm, email: e.target.value })}
                  helperText="Order confirmations & tracking will be sent here"
                />
                <TextField
                  fullWidth
                  label="Phone Number"
                  variant="outlined"
                  sx={{ mb: 3 }}
                  placeholder="(555) 123-4567"
                  value={leadForm.phone}
                  error={!!leadPhoneError}
                  helperText={leadPhoneError}
                  onChange={(e) => {
                    const formatted = formatPhoneNumber(e.target.value);
                    setLeadForm({ ...leadForm, phone: formatted });
                    setLeadPhoneError(validatePhone(formatted));
                  }}
                  InputProps={{
                    startAdornment: (
                      <InputAdornment position="start">
                        <span className="material-icons" style={{ fontSize: 18 }}>phone</span>
                      </InputAdornment>
                    )
                  }}
                />
                <Button
                  variant="contained" size="large" fullWidth
                  onClick={createGroup}
                  disabled={!leadForm.firstName || !leadForm.lastName || !leadForm.email || !!leadPhoneError}
                  sx={{
                    borderRadius: 99, py: 1.5,
                    fontFamily: "'Space Grotesk', sans-serif",
                    fontWeight: 700, fontSize: '1rem',
                    textTransform: 'none',
                    background: 'linear-gradient(135deg, #7c3aed, #db2777)',
                    boxShadow: '0 4px 16px rgba(124,58,237,0.3)',
                    '&:hover': { boxShadow: '0 6px 24px rgba(124,58,237,0.4)', transform: 'translateY(-1px)' },
                    transition: 'all 0.2s ease'
                  }}
                >
                  Let's Go! üéâ
                </Button>
                {group && (
                  <Alert severity="success" sx={{ mt: 2, borderRadius: 3, bgcolor: '#f0fdf4' }}>
                    Group #{group.id} created! Add members and set a recipient.
                  </Alert>
                )}
              </Paper>
            )}

            {/* Tab 1: Members & Recipient */}
            {tab === 1 && group && (
              <Grid container spacing={3}>
                <Grid item xs={12} md={6}>
                  <Paper sx={{
                    p: 3, borderRadius: 5,
                    border: '1px solid rgba(124,58,237,0.1)',
                    boxShadow: '0 8px 32px rgba(124,58,237,0.08)',
                    bgcolor: 'rgba(255,255,255,0.85)',
                    backdropFilter: 'blur(10px)'
                  }}>
                    <Typography variant="h6" gutterBottom sx={{
                      fontFamily: "'Space Grotesk', sans-serif",
                      fontWeight: 700
                    }}>
                      üéâ Invite Members
                    </Typography>
                    <TextField
                      fullWidth label="First Name" size="small" sx={{ mb: 1 }}
                      value={memberForm.firstName}
                      onChange={(e) => setMemberForm({ ...memberForm, firstName: e.target.value })}
                    />
                    <TextField
                      fullWidth label="Last Name" size="small" sx={{ mb: 1 }}
                      value={memberForm.lastName}
                      onChange={(e) => setMemberForm({ ...memberForm, lastName: e.target.value })}
                    />
                    <TextField
                      fullWidth label="Email" size="small" sx={{ mb: 1 }}
                      value={memberForm.email}
                      onChange={(e) => setMemberForm({ ...memberForm, email: e.target.value })}
                    />
                    <TextField
                      fullWidth
                      label="Phone Number"
                      size="small"
                      sx={{ mb: 2 }}
                      placeholder="(555) 123-4567"
                      value={memberForm.phone}
                      error={!!phoneError}
                      helperText={phoneError}
                      onChange={(e) => {
                        const formatted = formatPhoneNumber(e.target.value);
                        setMemberForm({ ...memberForm, phone: formatted });
                        setPhoneError(validatePhone(formatted));
                      }}
                      InputProps={{
                        startAdornment: (
                          <InputAdornment position="start">
                            <span className="material-icons" style={{ fontSize: 18 }}>phone</span>
                          </InputAdornment>
                        )
                      }}
                    />
                    <Button variant="outlined" onClick={addMember} disabled={!memberForm.email || !!phoneError}
                      sx={{ borderRadius: 99, textTransform: 'none', fontWeight: 600, borderColor: '#7c3aed', color: '#7c3aed', '&:hover': { borderColor: '#6d28d9', bgcolor: '#f3e8ff' } }}>
                      Add Member ‚ú®
                    </Button>

                    {group.members.length > 0 && (
                      <List sx={{ mt: 2 }}>
                        {group.members.map((m, i) => (
                          <ListItem key={i}>
                            <ListItemAvatar>
                              <Avatar sx={{ bgcolor: m.isLead ? '#f59e0b' : '#7c3aed', fontWeight: 700 }}>
                                {m.isLead ? <span className="material-icons" style={{ fontSize: 20 }}>star</span> : (m.firstName || m.email)[0].toUpperCase()}
                              </Avatar>
                            </ListItemAvatar>
                            <ListItemText
                              primary={
                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                  {`${m.firstName || ''} ${m.lastName || ''}`}
                                  {m.isLead && <Chip label="Group Lead" size="small" color="warning" sx={{ height: 20, fontSize: '0.7rem' }} />}
                                </Box>
                              }
                              secondary={<>{m.email}{m.phone && <><br/>{m.phone}</>}</>}
                            />
                          </ListItem>
                        ))}
                      </List>
                    )}
                  </Paper>
                </Grid>

                <Grid item xs={12} md={6}>
                  <Paper sx={{
                    p: 3, borderRadius: 5,
                    border: '1px solid rgba(219,39,119,0.1)',
                    boxShadow: '0 8px 32px rgba(219,39,119,0.08)',
                    bgcolor: 'rgba(255,255,255,0.85)',
                    backdropFilter: 'blur(10px)'
                  }}>
                    <Typography variant="h6" gutterBottom sx={{
                      fontFamily: "'Space Grotesk', sans-serif",
                      fontWeight: 700
                    }}>
                      üéÄ Gift Recipient
                    </Typography>
                    <Typography variant="body1" color="text.secondary" sx={{ mb: 2, lineHeight: 1.6 }}>
                      The gift ships here. The recipient won't get any order emails ‚Äî it stays a surprise! ü§´
                    </Typography>

                    <FormControl fullWidth sx={{ mb: 2 }}>
                      <InputLabel>Country/Region</InputLabel>
                      <Select
                        value={recipientForm.country}
                        label="Country/Region"
                        onChange={(e) => setRecipientForm({ ...recipientForm, country: e.target.value })}
                      >
                        <MenuItem value="United States">United States</MenuItem>
                        <MenuItem value="Canada">Canada</MenuItem>
                        <MenuItem value="United Kingdom">United Kingdom</MenuItem>
                      </Select>
                    </FormControl>

                    <Grid container spacing={2} sx={{ mb: 2 }}>
                      <Grid item xs={6}>
                        <TextField
                          fullWidth label="First name" variant="outlined"
                          value={recipientForm.firstName}
                          onChange={(e) => setRecipientForm({ ...recipientForm, firstName: e.target.value })}
                        />
                      </Grid>
                      <Grid item xs={6}>
                        <TextField
                          fullWidth label="Last name" variant="outlined"
                          value={recipientForm.lastName}
                          onChange={(e) => setRecipientForm({ ...recipientForm, lastName: e.target.value })}
                        />
                      </Grid>
                    </Grid>

                    <TextField
                      fullWidth
                      label="Phone Number"
                      variant="outlined"
                      sx={{ mb: 2 }}
                      value={recipientForm.phone}
                      error={!!recipientPhoneError}
                      helperText={recipientPhoneError || 'Required for delivery notifications'}
                      onChange={(e) => {
                        const formatted = formatPhoneNumber(e.target.value);
                        setRecipientForm({ ...recipientForm, phone: formatted });
                        if (formatted && formatted.replace(/\D/g, '').length >= 10) setRecipientPhoneError('');
                      }}
                      onBlur={() => {
                        if (recipientForm.phone) {
                          const err = validatePhone(recipientForm.phone);
                          setRecipientPhoneError(err || '');
                        }
                      }}
                      InputProps={{
                        startAdornment: <InputAdornment position="start"><span className="material-icons" style={{ fontSize: 20 }}>phone</span></InputAdornment>
                      }}
                    />

                    <AddressAutocomplete
                      value={recipientForm.address1}
                      onChange={(val) => setRecipientForm({ ...recipientForm, address1: val })}
                      onPlaceSelected={(place) => {
                        setRecipientForm(prev => ({
                          ...prev,
                          address1: place.address1 || prev.address1,
                          address2: place.address2 || prev.address2,
                          city: place.city || prev.city,
                          state: place.state || prev.state,
                          postalCode: place.postalCode || prev.postalCode
                        }));
                      }}
                    />

                    <TextField
                      fullWidth
                      label="Apt, suite, etc. (optional)"
                      variant="outlined"
                      sx={{ mb: 2 }}
                      inputProps={{ maxLength: 35 }}
                      value={recipientForm.address2}
                      onChange={(e) => setRecipientForm({ ...recipientForm, address2: e.target.value })}
                    />

                    <Grid container spacing={2} sx={{ mb: 3 }}>
                      <Grid item xs={5}>
                        <TextField
                          fullWidth label="City" variant="outlined"
                          value={recipientForm.city}
                          onChange={(e) => setRecipientForm({ ...recipientForm, city: e.target.value })}
                        />
                      </Grid>
                      <Grid item xs={4}>
                        <FormControl fullWidth>
                          <InputLabel>State</InputLabel>
                          <Select
                            value={recipientForm.state}
                            label="State"
                            onChange={(e) => setRecipientForm({ ...recipientForm, state: e.target.value })}
                          >
                            {US_STATES.map(state => (
                              <MenuItem key={state} value={state}>{state}</MenuItem>
                            ))}
                          </Select>
                        </FormControl>
                      </Grid>
                      <Grid item xs={3}>
                        <TextField
                          fullWidth label="ZIP code" variant="outlined"
                          value={recipientForm.postalCode}
                          onChange={(e) => setRecipientForm({ ...recipientForm, postalCode: e.target.value })}
                        />
                      </Grid>
                    </Grid>

                    <Button
                      variant="contained"
                      fullWidth
                      size="large"
                      onClick={setRecipient}
                      disabled={!recipientForm.firstName || !recipientForm.phone || !recipientForm.address1 || !recipientForm.city || !recipientForm.state}
                      sx={{
                        borderRadius: 99, py: 1.5,
                        fontFamily: "'Space Grotesk', sans-serif",
                        fontWeight: 700, fontSize: '1rem',
                        textTransform: 'none',
                        background: 'linear-gradient(135deg, #db2777, #7c3aed)',
                        boxShadow: '0 4px 16px rgba(219,39,119,0.3)',
                        '&:hover': { boxShadow: '0 6px 24px rgba(219,39,119,0.4)', transform: 'translateY(-1px)' },
                        transition: 'all 0.2s ease'
                      }}
                    >
                      Save & Browse Gifts üõçÔ∏è
                    </Button>

                    {group.recipient && (
                      <Alert severity="info" sx={{ mt: 2 }}>
                        Shipping to: {group.recipient.firstName} {group.recipient.lastName}, {group.recipient.city}, {group.recipient.state}
                      </Alert>
                    )}
                  </Paper>
                </Grid>
              </Grid>
            )}

            {/* Tab 2: Products Grid */}
            {tab === 2 && (
              <Box>
                <Paper sx={{
                  p: 2, mb: 3, borderRadius: 99,
                  border: '1px solid rgba(124,58,237,0.1)',
                  boxShadow: '0 4px 20px rgba(124,58,237,0.06)',
                  bgcolor: 'rgba(255,255,255,0.9)',
                  display: 'flex', alignItems: 'center', gap: 1
                }}>
                  <TextField
                    fullWidth
                    placeholder="Search for the perfect gift... üîç"
                    value={search}
                    onChange={handleSearch}
                    variant="standard"
                    InputProps={{
                      disableUnderline: true,
                      sx: { px: 1, fontFamily: "'DM Sans', sans-serif", fontSize: '1rem' },
                      startAdornment: (
                        <InputAdornment position="start">
                          <span className="material-icons" style={{ color: '#7c3aed' }}>search</span>
                        </InputAdornment>
                      )
                    }}
                  />
                  {source && (
                    <Chip
                      size="small"
                      label={source === 'shopify_catalog_api' ? '‚ú® Live Catalog' : 'Mock'}
                      sx={{
                        bgcolor: source === 'shopify_catalog_api' ? '#f0fdf4' : '#f5f5f5',
                        color: source === 'shopify_catalog_api' ? '#16a34a' : '#888',
                        fontWeight: 600, borderRadius: 99
                      }}
                    />
                  )}
                </Paper>

                {loading ? (
                  <Box sx={{ display: 'flex', justifyContent: 'center', py: 5 }}>
                    <CircularProgress />
                  </Box>
                ) : (
                  <Grid container spacing={3}>
                    {products.map((product) => (
                      <Grid item xs={6} sm={4} md={3} key={product.id}>
                        <Card sx={{
                          height: '100%', display: 'flex', flexDirection: 'column',
                          borderRadius: 4,
                          border: '1px solid rgba(0,0,0,0.06)',
                          boxShadow: '0 4px 20px rgba(0,0,0,0.04)',
                          bgcolor: 'rgba(255,255,255,0.9)',
                          transition: 'all 0.25s ease',
                          overflow: 'hidden',
                          '&:hover': { transform: 'translateY(-6px) scale(1.01)', boxShadow: '0 12px 40px rgba(124,58,237,0.12)' }
                        }}>
                          <CardMedia
                            component="img"
                            height="180"
                            image={product.image || 'https://via.placeholder.com/300x200?text=No+Image'}
                            alt={product.title}
                            sx={{ objectFit: 'cover', bgcolor: '#faf5ff' }}
                          />
                          <CardContent sx={{ flexGrow: 1, pb: 1 }}>
                            <Typography variant="subtitle2" sx={{
                              fontFamily: "'DM Sans', sans-serif",
                              fontWeight: 600, lineHeight: 1.3, mb: 0.5,
                              display: '-webkit-box', WebkitLineClamp: 2, WebkitBoxOrient: 'vertical', overflow: 'hidden'
                            }}>
                              {product.title}
                            </Typography>
                            {product.merchant && (
                              <Typography variant="caption" color="text.secondary" display="block" sx={{ fontWeight: 500 }}>
                                {product.merchant}
                              </Typography>
                            )}
                            {product.rating && (
                              <Box sx={{ display: 'flex', alignItems: 'center', mt: 0.5 }}>
                                <Rating value={product.rating} precision={0.1} size="small" readOnly
                                  sx={{ '& .MuiRating-iconFilled': { color: '#f59e0b' } }} />
                                <Typography variant="caption" sx={{ ml: 0.5 }}>({product.reviewCount})</Typography>
                              </Box>
                            )}
                            <Typography variant="h6" sx={{
                              mt: 1, fontFamily: "'Space Grotesk', sans-serif",
                              fontWeight: 700, color: '#7c3aed'
                            }}>
                              {product.price ? `$${product.price}` : ''}
                            </Typography>
                          </CardContent>
                          <CardActions sx={{ pt: 0, px: 2, pb: 2 }}>
                            <Button
                              variant="contained"
                              size="small"
                              fullWidth
                              onClick={() => addToCart(product)}
                              sx={{
                                borderRadius: 99, textTransform: 'none',
                                fontWeight: 700, fontSize: '0.85rem',
                                background: 'linear-gradient(135deg, #7c3aed, #db2777)',
                                boxShadow: '0 2px 8px rgba(124,58,237,0.25)',
                                '&:hover': { boxShadow: '0 4px 16px rgba(124,58,237,0.35)' },
                                transition: 'all 0.2s ease'
                              }}
                            >
                              üéÅ Gift This
                            </Button>
                          </CardActions>
                        </Card>
                      </Grid>
                    ))}
                  </Grid>
                )}

                {!loading && products.length === 0 && (
                  <Paper sx={{ p: 5, textAlign: 'center', borderRadius: 5, bgcolor: 'rgba(255,255,255,0.8)' }}>
                    <Typography sx={{ fontSize: 48, mb: 1 }}>üîç</Typography>
                    <Typography variant="h6" sx={{ fontFamily: "'Space Grotesk', sans-serif", fontWeight: 600, mb: 0.5 }}>No gifts found</Typography>
                    <Typography color="text.secondary">Try a different search term</Typography>
                  </Paper>
                )}
              </Box>
            )}
          </Container>

          {/* Shopping Cart Dialog */}
          <Dialog
            open={cartOpen}
            onClose={() => setCartOpen(false)}
            maxWidth="md"
            fullWidth
            PaperProps={{ sx: { maxHeight: '90vh', borderRadius: 5, overflow: 'hidden' } }}
          >
            <DialogTitle sx={{
              display: 'flex', justifyContent: 'space-between', alignItems: 'center',
              background: 'linear-gradient(135deg, #7c3aed, #db2777)',
              color: 'white', py: 2.5
            }}>
              <Typography variant="h5" sx={{ fontFamily: "'Space Grotesk', sans-serif", fontWeight: 700 }}>üõçÔ∏è Gift Bag</Typography>
              <Chip label={`${cartCount} items`} sx={{ bgcolor: 'rgba(255,255,255,0.2)', color: 'white', fontWeight: 700, borderRadius: 99 }} />
            </DialogTitle>
            <DialogContent sx={{ p: 0 }}>
              {cart.length === 0 ? (
                <Box sx={{ p: 5, textAlign: 'center' }}>
                  <Typography sx={{ fontSize: 56, mb: 1 }}>üõçÔ∏è</Typography>
                  <Typography variant="h6" sx={{ fontFamily: "'Space Grotesk', sans-serif", fontWeight: 600, mb: 0.5 }}>Nothing here yet!</Typography>
                  <Typography color="text.secondary" sx={{ mb: 3 }}>Find something special for your person</Typography>
                  <Button variant="contained" onClick={() => { setCartOpen(false); setTab(2); }}
                    sx={{ borderRadius: 99, textTransform: 'none', fontWeight: 700, background: 'linear-gradient(135deg, #7c3aed, #db2777)', px: 4 }}>
                    Browse Gifts üéÅ
                  </Button>
                </Box>
              ) : (
                <Grid container>
                  {/* Cart Items */}
                  <Grid item xs={12} md={8} sx={{ borderRight: { md: '1px solid #eee' } }}>
                    {cart.map((item, index) => (
                      <Box key={item.id}>
                        <Box sx={{ display: 'flex', p: 3, gap: 3 }}>
                          <Box
                            component="img"
                            src={item.image || 'https://via.placeholder.com/120x150?text=No+Image'}
                            alt={item.title}
                            sx={{ width: 120, height: 150, objectFit: 'cover', borderRadius: 1, bgcolor: '#f5f5f5' }}
                          />
                          <Box sx={{ flex: 1 }}>
                            <Typography variant="subtitle1" sx={{ fontWeight: 600, mb: 0.5 }}>
                              {item.title}
                            </Typography>
                            {item.merchant && (
                              <Typography variant="body2" color="text.secondary">
                                Sold by: {item.merchant}
                              </Typography>
                            )}

                            {/* Quantity Controls */}
                            <Box sx={{ display: 'flex', alignItems: 'center', mt: 2, gap: 1 }}>
                              <Box sx={{ display: 'flex', alignItems: 'center', border: '1px solid #ddd', borderRadius: 1 }}>
                                <IconButton
                                  size="small"
                                  onClick={() => updateQuantity(item.id, -1)}
                                  disabled={item.quantity <= 1}
                                >
                                  <span className="material-icons" style={{ fontSize: 18 }}>remove</span>
                                </IconButton>
                                <Typography sx={{ px: 2, minWidth: 30, textAlign: 'center' }}>{item.quantity}</Typography>
                                <IconButton size="small" onClick={() => updateQuantity(item.id, 1)}>
                                  <span className="material-icons" style={{ fontSize: 18 }}>add</span>
                                </IconButton>
                              </Box>
                            </Box>

                            <Box sx={{ display: 'flex', alignItems: 'center', mt: 2, gap: 2 }}>
                              <Button
                                size="small"
                                sx={{ textTransform: 'none', textDecoration: 'underline', p: 0, minWidth: 'auto' }}
                                onClick={() => removeFromCart(item.id)}
                              >
                                Remove
                              </Button>
                            </Box>
                          </Box>

                          <Box sx={{ textAlign: 'right', minWidth: 100 }}>
                            <Typography variant="h6" sx={{ fontWeight: 600 }}>
                              ${((parseFloat(item.price) || 0) * item.quantity).toFixed(0)}
                            </Typography>
                            <Button
                              variant="contained"
                              size="small"
                              disabled={checkoutLoading || !item.variantId}
                              sx={{
                                mt: 2, borderRadius: 99,
                                textTransform: 'none', fontWeight: 700,
                                background: 'linear-gradient(135deg, #7c3aed, #db2777)',
                                boxShadow: '0 2px 8px rgba(124,58,237,0.25)',
                                '&:hover': { boxShadow: '0 4px 16px rgba(124,58,237,0.35)' },
                                px: 2.5
                              }}
                              onClick={() => checkoutItem(item)}
                            >
                              {checkoutLoading ? <CircularProgress size={20} color="inherit" /> : 'Checkout üí´'}
                            </Button>
                            {!item.variantId && (
                              <Typography variant="caption" color="error" display="block" sx={{ mt: 0.5 }}>
                                Not available
                              </Typography>
                            )}
                          </Box>
                        </Box>
                        {index < cart.length - 1 && <Divider />}
                      </Box>
                    ))}
                  </Grid>

                  {/* Order Summary */}
                  <Grid item xs={12} md={4}>
                    <Box sx={{ p: 3 }}>
                      <Typography variant="h6" sx={{
                        fontFamily: "'Space Grotesk', sans-serif",
                        fontWeight: 700, mb: 2
                      }}>
                        ‚ú® Order Summary
                      </Typography>

                      <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 1 }}>
                        <Typography>Subtotal:</Typography>
                        <Typography sx={{ fontWeight: 600 }}>${cartTotal.toFixed(0)}</Typography>
                      </Box>
                      <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 3 }}>
                        <Typography>Shipping:</Typography>
                        <Typography sx={{ fontWeight: 600 }}>Calculated at checkout</Typography>
                      </Box>

                      <Divider sx={{ my: 2 }} />

                      {group && group.recipient && (
                        <Alert severity="info" sx={{ mb: 2 }}>
                          <Typography variant="body2" sx={{ fontWeight: 600 }}>Shipping to:</Typography>
                          <Typography variant="body2">{group.recipient.firstName} {group.recipient.lastName}</Typography>
                          <Typography variant="body2">{group.recipient.address1}</Typography>
                          <Typography variant="body2">{group.recipient.city}, {group.recipient.state} {group.recipient.postalCode}</Typography>
                        </Alert>
                      )}

                      {group && (
                        <Alert severity="success" icon={<span className="material-icons">email</span>}>
                          <Typography variant="body2">Order confirmations will go to <strong>{group.lead.email}</strong> (not the recipient)</Typography>
                        </Alert>
                      )}

                      {!group && (
                        <Alert severity="warning">
                          <Typography variant="body2">Create a group and set recipient before checkout</Typography>
                        </Alert>
                      )}
                    </Box>
                  </Grid>
                </Grid>
              )}
            </DialogContent>
          </Dialog>

          {/* MCP Checkout Response Modal */}
          <Dialog
            open={!!checkoutResponse}
            onClose={() => setCheckoutResponse(null)}
            maxWidth="md"
            fullWidth
          >
            <DialogTitle sx={{
              background: checkoutResponse?.success ? 'linear-gradient(135deg, #16a34a, #059669)' : 'linear-gradient(135deg, #ef4444, #db2777)',
              color: 'white', display: 'flex', alignItems: 'center', gap: 1,
              fontFamily: "'Space Grotesk', sans-serif"
            }}>
              {checkoutResponse?.success ? '‚úÖ' : '‚ùå'}
              MCP create_checkout {checkoutResponse?.success ? 'Response' : 'Error'}
            </DialogTitle>
            <DialogContent sx={{ mt: 2 }}>
              {checkoutResponse && (
                <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2, mt: 1 }}>
                  {/* Product info */}
                  <Paper variant="outlined" sx={{ p: 2 }}>
                    <Typography variant="subtitle2" color="text.secondary">Product</Typography>
                    <Typography variant="h6">{checkoutResponse.productTitle}</Typography>
                    {checkoutResponse.productPrice && (
                      <Typography variant="body2">Price: ${checkoutResponse.productPrice} √ó {checkoutResponse.quantity || 1}</Typography>
                    )}
                  </Paper>

                  {/* Group info */}
                  {checkoutResponse.groupInfo && (
                    <Paper variant="outlined" sx={{ p: 2 }}>
                      <Typography variant="subtitle2" color="text.secondary">Routing</Typography>
                      <Typography variant="body2"><strong>Buyer email:</strong> {checkoutResponse.groupInfo.leadEmail}</Typography>
                      <Typography variant="body2"><strong>Ship to:</strong> {checkoutResponse.groupInfo.recipientName}</Typography>
                      <Typography variant="body2">{checkoutResponse.groupInfo.recipientAddress}</Typography>
                    </Paper>
                  )}

                  {/* Checkout URL */}
                  {checkoutResponse.checkoutUrl && (
                    <Button
                      variant="contained"
                      color="success"
                      href={checkoutResponse.checkoutUrl}
                      target="_blank"
                      startIcon={<span className="material-icons">launch</span>}
                      sx={{ py: 1.5 }}
                    >
                      Open Checkout
                    </Button>
                  )}

                  {/* Error */}
                  {checkoutResponse.error && (
                    <Alert severity="error">
                      <Typography variant="body2" sx={{ fontWeight: 600 }}>Error</Typography>
                      <Typography variant="body2" sx={{ fontFamily: 'monospace', whiteSpace: 'pre-wrap', wordBreak: 'break-all', mt: 0.5 }}>
                        {typeof checkoutResponse.error === 'string' ? checkoutResponse.error : JSON.stringify(checkoutResponse.error, null, 2)}
                      </Typography>
                    </Alert>
                  )}

                  {/* Request payload */}
                  {checkoutResponse.requestPayload && (
                    <Paper variant="outlined" sx={{ p: 2 }}>
                      <Typography variant="subtitle2" color="text.secondary" sx={{ mb: 1 }}>
                        UCP/MCP Request ‚Üí {checkoutResponse.ucpEndpoint || 'POST {shopDomain}/api/ucp/mcp'}
                      </Typography>
                      <Box sx={{ bgcolor: '#263238', color: '#e0e0e0', p: 2, borderRadius: 1, maxHeight: 250, overflow: 'auto' }}>
                        <pre style={{ margin: 0, fontSize: 12, whiteSpace: 'pre-wrap', wordBreak: 'break-all' }}>
                          {JSON.stringify(checkoutResponse.requestPayload, null, 2)}
                        </pre>
                      </Box>
                    </Paper>
                  )}

                  {/* MCP response */}
                  <Paper variant="outlined" sx={{ p: 2 }}>
                    <Typography variant="subtitle2" color="text.secondary" sx={{ mb: 1 }}>UCP/MCP Response</Typography>
                    <Box sx={{ bgcolor: '#263238', color: '#e0e0e0', p: 2, borderRadius: 1, maxHeight: 250, overflow: 'auto' }}>
                      <pre style={{ margin: 0, fontSize: 12, whiteSpace: 'pre-wrap', wordBreak: 'break-all' }}>
                        {JSON.stringify(checkoutResponse.mcpResponse || { error: checkoutResponse.error }, null, 2)}
                      </pre>
                    </Box>
                  </Paper>
                </Box>
              )}
            </DialogContent>
            <DialogActions>
              <Button onClick={() => setCheckoutResponse(null)}>Close</Button>
            </DialogActions>
          </Dialog>

          {/* Embedded Checkout (ECP) Dialog */}
          {embeddedCheckout && (
            <EmbeddedCheckout
              continueUrl={embeddedCheckout.continueUrl}
              recipient={embeddedCheckout.recipient}
              productTitle={embeddedCheckout.productTitle}
              onComplete={(params) => {
                setEmbeddedCheckout(null);
                setOrderConfirmation(params);
                setSnackbar({ open: true, message: 'Order completed! üéâ', severity: 'success' });
              }}
              onClose={() => setEmbeddedCheckout(null)}
            />
          )}

          {/* Order Confirmation Dialog */}
          <Dialog
            open={!!orderConfirmation}
            onClose={() => setOrderConfirmation(null)}
            maxWidth="sm"
            fullWidth
          >
            <DialogTitle sx={{
              background: 'linear-gradient(135deg, #7c3aed, #db2777, #f59e0b)',
              color: 'white', display: 'flex', alignItems: 'center', gap: 1,
              fontFamily: "'Space Grotesk', sans-serif", fontWeight: 700
            }}>
              üéâ Order Confirmed!
            </DialogTitle>
            <DialogContent sx={{ mt: 2 }}>
              {orderConfirmation && (
                <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 2, py: 4 }}>
                  <Typography sx={{ fontSize: 72 }}>üéÅ</Typography>
                  <Typography variant="h4" sx={{
                    fontFamily: "'Space Grotesk', sans-serif",
                    fontWeight: 700, textAlign: 'center'
                  }}>
                    The gift is on its way!
                  </Typography>
                  {orderConfirmation?.checkout?.order?.id && (
                    <Typography variant="body2" color="text.secondary">
                      Order: {orderConfirmation.checkout.order.id}
                    </Typography>
                  )}
                  {group && (
                    <Alert severity="info" sx={{ width: '100%' }}>
                      <Typography variant="body2">
                        Confirmation sent to <strong>{group.lead.email}</strong>.
                        The recipient won't know until the gift arrives!
                      </Typography>
                    </Alert>
                  )}
                </Box>
              )}
            </DialogContent>
            <DialogActions>
              <Button variant="contained" onClick={() => setOrderConfirmation(null)}
                sx={{ borderRadius: 99, textTransform: 'none', fontWeight: 700, background: 'linear-gradient(135deg, #7c3aed, #db2777)', px: 4 }}>
                Done üéâ
              </Button>
            </DialogActions>
          </Dialog>

          {/* Snackbar notifications */}
          <Snackbar
            open={snackbar.open}
            autoHideDuration={4000}
            onClose={() => setSnackbar({ ...snackbar, open: false })}
            anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
          >
            <Alert severity={snackbar.severity} onClose={() => setSnackbar({ ...snackbar, open: false })}>
              {snackbar.message}
            </Alert>
          </Snackbar>
        </Box>
      );
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // EmbeddedCheckout Component ‚Äî ECP popup bridge
    //
    // Shopify's checkout CSP (frame-ancestors) blocks iframing from
    // third-party origins.  Popup windows are NOT subject to frame-ancestors,
    // so we open checkout in a popup and communicate via postMessage.
    //
    // JSON-RPC 2.0 protocol:
    //   Messages with `id` = Requests ‚Üí MUST respond
    //   Messages without `id` = Notifications ‚Üí no response
    //
    // Event flow:
    //   1. Checkout loads in popup
    //   2. Checkout sends ec.ready  (Request)  ‚Üí we respond { id, result:{} }
    //   3. Checkout sends ec.start  (Notification)
    //   4. Checkout may send ec.fulfillment.address_change_request (Request)
    //   5. Checkout sends ec.complete (Notification) when done
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function EmbeddedCheckout({ continueUrl, recipient, productTitle, onComplete, onClose }) {
      const checkoutWindowRef = React.useRef(null);
      const completedRef = React.useRef(false);
      const [ecpStatus, setEcpStatus] = React.useState('loading');
      const [embeddedUrl, setEmbeddedUrl] = React.useState(null);
      const [ecpError, setEcpError] = React.useState(null);
      const [addressRequested, setAddressRequested] = React.useState(false);
      const [showRecipientEdit, setShowRecipientEdit] = React.useState(false);
      const [editRecipient, setEditRecipient] = React.useState(null);
      const pendingAddressRequestId = React.useRef(null);
      const acceptedDelegations = React.useRef([]);
      const checkoutOriginRef = React.useRef('*');

      // Build the ECP-enriched URL on mount, then open popup
      React.useEffect(() => {
        let pollTimer;

        fetch('/api/embedded-checkout-url', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ continue_url: continueUrl })
        })
          .then(r => r.json())
          .then(data => {
            if (!data.embedded_url) {
              setEcpError(data.error || 'Failed to build embedded checkout URL');
              setEcpStatus('error');
              return;
            }

            console.log('[ECP] üîó Embedded checkout URL:', data.embedded_url);
            setEmbeddedUrl(data.embedded_url);
            setEcpStatus('connecting');

            // Open checkout in a popup (bypasses frame-ancestors CSP)
            const w = 480, h = 720;
            const left = (window.screen.width - w) / 2;
            const top = (window.screen.height - h) / 2;
            checkoutWindowRef.current = window.open(
              data.embedded_url,
              'shopify_checkout',
              `width=${w},height=${h},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
            );

            if (!checkoutWindowRef.current) {
              setEcpError('Popup blocked ‚Äî please allow popups for this site');
              setEcpStatus('error');
              return;
            }

            console.log('[ECP] üì§ Popup opened, waiting for ec.ready...');

            // Poll for popup being closed manually
            pollTimer = setInterval(() => {
              if (checkoutWindowRef.current && checkoutWindowRef.current.closed) {
                clearInterval(pollTimer);
                if (!completedRef.current) {
                  onClose();
                }
              }
            }, 500);
          })
          .catch(err => {
            setEcpError(err.message);
            setEcpStatus('error');
          });

        return () => {
          if (pollTimer) clearInterval(pollTimer);
          if (checkoutWindowRef.current && !checkoutWindowRef.current.closed) {
            checkoutWindowRef.current.close();
          }
        };
      }, [continueUrl]);

      // ‚îÄ‚îÄ ECP postMessage listener ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      React.useEffect(() => {
        function handleMessage(event) {
          // Log ALL postMessage events for debugging (truncate large data)
          const preview = typeof event.data === 'string'
            ? event.data.slice(0, 300)
            : JSON.stringify(event.data).slice(0, 300);
          console.log('[ECP] üì© postMessage from', event.origin, ':', preview);

          let msg;
          try {
            msg = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
          } catch {
            console.log('[ECP] ‚ö†Ô∏è Non-JSON message ignored');
            return;
          }

          // Handle JSON-RPC 2.0 messages with ec.* methods
          if (!msg || msg.jsonrpc !== '2.0' || !msg.method) {
            console.log('[ECP] ‚ö†Ô∏è Not a JSON-RPC request/notification, ignoring:', msg);
            return;
          }
          if (!msg.method.startsWith('ec.')) {
            console.log('[ECP] ‚ö†Ô∏è Non-ec.* method ignored:', msg.method);
            return;
          }

          console.log('[ECP] ‚Üê Received:', msg.method, JSON.stringify(msg, null, 2));

          // Store the checkout origin for validated responses
          if (event.origin && event.origin !== 'null') {
            checkoutOriginRef.current = event.origin;
          }

          switch (msg.method) {
            // ‚îÄ‚îÄ ec.ready (Request ‚Äî MUST respond) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // This initializes the ECP channel. We echo back the request id.
            case 'ec.ready': {
              const delegations = msg.params?.delegate || [];
              acceptedDelegations.current = delegations;
              console.log('[ECP] Delegations accepted:', delegations);
              console.log('[ECP] Checkout origin:', checkoutOriginRef.current);
              setEcpStatus('ready');
              respondToCheckout(msg.id, {});
              break;
            }

            // ‚îÄ‚îÄ ec.start (Notification ‚Äî no response) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            case 'ec.start':
              setEcpStatus('active');
              console.log('[ECP] Checkout visible and interactive:', msg.params);
              break;

            // ‚îÄ‚îÄ ec.fulfillment.address_change_request (Request) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            case 'ec.fulfillment.address_change_request':
              handleAddressChangeRequest(msg.id, msg.params);
              break;

            // ‚îÄ‚îÄ ec.payment.instruments_change_request (Request) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            case 'ec.payment.instruments_change_request':
              console.log('[ECP] Payment instruments change requested:', msg.params);
              respondWithError(msg.id, 'Payment instrument selection not delegated.');
              break;

            // ‚îÄ‚îÄ ec.payment.credential_request (Request) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            case 'ec.payment.credential_request':
              console.log('[ECP] Payment credential requested:', msg.params);
              respondWithError(msg.id, 'Payment credential not delegated.');
              break;

            // ‚îÄ‚îÄ ec.payment.change (Notification) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            case 'ec.payment.change':
              console.log('[ECP] Payment changed:', msg.params);
              break;

            // ‚îÄ‚îÄ ec.fulfillment.change (Notification) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            case 'ec.fulfillment.change':
              console.log('[ECP] Fulfillment changed:', msg.params);
              break;

            // ‚îÄ‚îÄ ec.messages.change (Notification ‚Äî checkout errors/info) ‚îÄ
            case 'ec.messages.change':
              console.log('[ECP] ‚ö†Ô∏è Messages changed:', JSON.stringify(msg.params, null, 2));
              if (msg.params?.checkout?.messages) {
                msg.params.checkout.messages.forEach(m => {
                  console.log(`[ECP]   ${m.severity || m.type}: ${m.content || m.code}`);
                });
              }
              break;

            // ‚îÄ‚îÄ ec.line_items.change (Notification) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            case 'ec.line_items.change':
              console.log('[ECP] Line items changed:', msg.params);
              break;

            // ‚îÄ‚îÄ ec.buyer.change (Notification) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            case 'ec.buyer.change':
              console.log('[ECP] Buyer changed:', msg.params);
              break;

            // ‚îÄ‚îÄ ec.complete (Notification ‚Äî no response) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            case 'ec.complete':
              setEcpStatus('complete');
              completedRef.current = true;
              console.log('[ECP] ‚úÖ Checkout complete:', msg.params);
              if (checkoutWindowRef.current && !checkoutWindowRef.current.closed) {
                checkoutWindowRef.current.close();
              }
              if (onComplete) onComplete(msg.params);
              break;

            default:
              console.log('[ECP] Unhandled event:', msg.method, msg);
          }
        }

        window.addEventListener('message', handleMessage);
        return () => window.removeEventListener('message', handleMessage);
      }, [recipient, onComplete]);

      // ‚îÄ‚îÄ Send JSON-RPC 2.0 response to checkout popup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // The ECP spec for web hosts uses postMessage between windows.
      // We send as a JSON string (per ECP spec) AND as a structured object
      // (per standard web postMessage), to cover both possible Shopify
      // implementations. The targetOrigin is the checkout's validated origin.
      function respondToCheckout(id, result) {
        const win = checkoutWindowRef.current;
        if (!win || win.closed) {
          console.warn('[ECP] Cannot respond ‚Äî popup closed');
          return;
        }
        const origin = checkoutOriginRef.current || '*';
        const response = { jsonrpc: '2.0', id, result };
        console.log('[ECP] ‚Üí Responding to', origin, ':', JSON.stringify(response));
        // Send as JSON string (ECP native spec format)
        win.postMessage(JSON.stringify(response), origin);
        // Also send as structured object (standard web postMessage format)
        win.postMessage(response, origin);
      }

      // ‚îÄ‚îÄ Send JSON-RPC 2.0 error response ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function respondWithError(id, message) {
        const win = checkoutWindowRef.current;
        if (!win || win.closed) return;
        const origin = checkoutOriginRef.current || '*';
        const response = { jsonrpc: '2.0', id, error: { code: 'abort_error', message } };
        console.log('[ECP] ‚Üí Error response to', origin, ':', JSON.stringify(response));
        win.postMessage(JSON.stringify(response), origin);
        win.postMessage(response, origin);
      }

      // Handle ec.fulfillment.address_change_request
      // Always show the recipient address edit panel so the user can
      // review / update the gift recipient's address from our app,
      // rather than falling through to Shopify's built-in address form.
      function handleAddressChangeRequest(id, params) {
        console.log('[ECP] üìç Address change requested ‚Äî showing recipient editor');
        setAddressRequested(true);
        pendingAddressRequestId.current = id;
        setEditRecipient({
          firstName: recipient?.firstName || '',
          lastName: recipient?.lastName || '',
          address1: recipient?.address1 || '',
          city: recipient?.city || '',
          state: recipient?.state || '',
          provinceCode: recipient?.provinceCode || '',
          postalCode: recipient?.postalCode || '',
          country: recipient?.country || 'United States'
        });
        setShowRecipientEdit(true);
      }

      function respondWithRecipientAddress(id, addr) {
        respondToCheckout(id, {
          checkout: {
            fulfillment: {
              methods: [{
                type: 'shipping',
                selected_destination_id: 'gift-recipient-address',
                destinations: [{
                  id: 'gift-recipient-address',
                  first_name: addr.firstName,
                  last_name: addr.lastName,
                  street_address: addr.address1,
                  address_locality: addr.city,
                  address_region: addr.provinceCode || STATE_CODES[addr.state] || addr.state,
                  postal_code: addr.postalCode,
                  address_country: addr.country === 'United States' ? 'US' :
                                   addr.country === 'Canada' ? 'CA' : 'US'
                }]
              }]
            }
          }
        });
        console.log('[ECP] Sent recipient address for', addr.firstName, addr.lastName);
      }

      function submitEditedAddress() {
        if (!editRecipient || !pendingAddressRequestId.current) return;
        const addr = { ...editRecipient, provinceCode: STATE_CODES[editRecipient.state] || editRecipient.state };
        respondWithRecipientAddress(pendingAddressRequestId.current, addr);
        pendingAddressRequestId.current = null;
        setShowRecipientEdit(false);
      }

      function cancelAddressEdit() {
        if (pendingAddressRequestId.current) {
          respondWithError(pendingAddressRequestId.current, 'User cancelled address selection.');
          pendingAddressRequestId.current = null;
        }
        setShowRecipientEdit(false);
      }

      function handleClose() {
        if (checkoutWindowRef.current && !checkoutWindowRef.current.closed) {
          checkoutWindowRef.current.close();
        }
        onClose();
      }

      const statusLabels = {
        loading: 'Preparing checkout...',
        connecting: 'Opening checkout...',
        ready: 'Checkout ready',
        active: 'Checkout in progress',
        complete: 'Order complete!',
        error: 'Checkout error'
      };

      return (
        <Dialog open onClose={handleClose} maxWidth="sm" fullWidth>
          {/* Header */}
          <AppBar position="relative" elevation={0} sx={{
            background: ecpStatus === 'complete'
              ? 'linear-gradient(135deg, #16a34a, #059669)'
              : ecpStatus === 'error'
                ? 'linear-gradient(135deg, #ef4444, #db2777)'
                : 'linear-gradient(135deg, #7c3aed, #db2777)'
          }}>
            <Toolbar>
              <IconButton edge="start" color="inherit" onClick={handleClose}>
                <span className="material-icons">close</span>
              </IconButton>
              <Box sx={{ flex: 1, ml: 1 }}>
                <Typography variant="h6" sx={{ fontFamily: "'Space Grotesk', sans-serif", fontWeight: 700 }}>
                  {ecpStatus === 'complete' ? 'üéâ Order Confirmed!' : `üí≥ Checkout ‚Äî ${productTitle || 'Gift'}`}
                </Typography>
                <Typography variant="caption" sx={{ opacity: 0.85 }}>
                  {statusLabels[ecpStatus]}
                  {addressRequested && ecpStatus === 'active' && ' ‚Ä¢ Recipient address sent ‚úì'}
                </Typography>
              </Box>
              {(ecpStatus === 'loading' || ecpStatus === 'connecting') && (
                <CircularProgress size={24} sx={{ color: 'white' }} />
              )}
            </Toolbar>
          </AppBar>

          <DialogContent sx={{ py: 4 }}>
            {/* Error state */}
            {ecpStatus === 'error' && (
              <Box sx={{ textAlign: 'center' }}>
                <span className="material-icons" style={{ fontSize: 64, color: '#f44336' }}>error_outline</span>
                <Typography variant="h6" sx={{ mt: 2, mb: 1 }}>Couldn't load checkout</Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 3 }}>{ecpError}</Typography>
                <Button variant="contained" onClick={handleClose}
                  sx={{ borderRadius: 99, textTransform: 'none', fontWeight: 700, background: 'linear-gradient(135deg, #7c3aed, #db2777)' }}>
                  Go Back
                </Button>
              </Box>
            )}

            {/* Loading state */}
            {ecpStatus === 'loading' && (
              <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 2, py: 4 }}>
                <CircularProgress size={48} />
                <Typography color="text.secondary">Preparing checkout...</Typography>
              </Box>
            )}

            {/* Active states ‚Äî checkout is in popup */}
            {['connecting', 'ready', 'active'].includes(ecpStatus) && (
              <Box sx={{ textAlign: 'center', py: 4 }}>
                <Typography sx={{ fontSize: 56, mb: 1 }}>üí≥</Typography>
                <Typography variant="h6" sx={{ mt: 1, mb: 1, fontFamily: "'Space Grotesk', sans-serif", fontWeight: 700 }}>
                  Complete checkout in the popup
                </Typography>
                <Typography variant="body1" color="text.secondary" sx={{ mb: 3, maxWidth: 320, mx: 'auto', lineHeight: 1.6 }}>
                  A checkout window opened. Complete your payment there!
                </Typography>

                {/* ECP status indicator */}
                <Paper sx={{ display: 'inline-flex', alignItems: 'center', gap: 1, px: 2, py: 1, mb: 3,
                  borderRadius: 99, bgcolor: ecpStatus === 'active' ? '#f0fdf4' : ecpStatus === 'ready' ? '#eff6ff' : '#faf5ff',
                  border: `1px solid ${ecpStatus === 'active' ? 'rgba(22,163,74,0.2)' : ecpStatus === 'ready' ? 'rgba(59,130,246,0.2)' : 'rgba(124,58,237,0.2)'}`
                }}>
                  <Typography sx={{ fontSize: 14 }}>
                    {ecpStatus === 'active' ? 'üü¢' : ecpStatus === 'ready' ? 'üîµ' : 'üü°'}
                  </Typography>
                  <Typography variant="body2" sx={{ fontWeight: 600 }}>
                    {ecpStatus === 'connecting' && 'Waiting for ec.ready...'}
                    {ecpStatus === 'ready' && 'ECP handshake complete ‚úì'}
                    {ecpStatus === 'active' && 'Checkout active'}
                  </Typography>
                </Paper>

                <Box sx={{ display: 'flex', justifyContent: 'center' }}>
                  <Button variant="contained" onClick={() => {
                    if (checkoutWindowRef.current && !checkoutWindowRef.current.closed) {
                      checkoutWindowRef.current.focus();
                    }
                  }} sx={{
                    borderRadius: 99, textTransform: 'none', fontWeight: 700,
                    background: 'linear-gradient(135deg, #7c3aed, #db2777)', px: 3
                  }}>
                    Focus Checkout Window ‚ú®
                  </Button>
                </Box>
              </Box>
            )}

            {/* Complete state */}
            {ecpStatus === 'complete' && (
              <Box sx={{ textAlign: 'center', py: 4 }}>
                <Typography sx={{ fontSize: 72 }}>üéâ</Typography>
                <Typography variant="h5" sx={{ mt: 1, mb: 1, fontFamily: "'Space Grotesk', sans-serif", fontWeight: 700 }}>
                  Order placed!
                </Typography>
                <Typography variant="body1" color="text.secondary" sx={{ mb: 3, lineHeight: 1.6 }}>
                  Your gift has been purchased and is on its way to the lucky recipient!
                </Typography>
                <Button variant="contained" onClick={handleClose}
                  sx={{ borderRadius: 99, textTransform: 'none', fontWeight: 700, background: 'linear-gradient(135deg, #7c3aed, #db2777)', px: 4 }}>
                  Done üéÅ
                </Button>
              </Box>
            )}

            {/* Recipient address edit overlay */}
            {showRecipientEdit && editRecipient && (
              <Paper sx={{ p: 3, mt: 2, border: '2px solid rgba(124,58,237,0.2)', borderRadius: 4, bgcolor: '#faf5ff' }}>
                <Typography variant="h6" sx={{ mb: 2, fontFamily: "'Space Grotesk', sans-serif", fontWeight: 700 }}>
                  üìç Gift Recipient Address
                </Typography>
                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                  The checkout is requesting a shipping address. Confirm or update below.
                </Typography>
                <Grid container spacing={2} sx={{ mb: 2 }}>
                  <Grid item xs={6}>
                    <TextField fullWidth label="First name" size="small" value={editRecipient.firstName}
                      onChange={(e) => setEditRecipient({ ...editRecipient, firstName: e.target.value })} />
                  </Grid>
                  <Grid item xs={6}>
                    <TextField fullWidth label="Last name" size="small" value={editRecipient.lastName}
                      onChange={(e) => setEditRecipient({ ...editRecipient, lastName: e.target.value })} />
                  </Grid>
                </Grid>
                <TextField fullWidth label="Address" size="small" sx={{ mb: 2 }} value={editRecipient.address1}
                  onChange={(e) => setEditRecipient({ ...editRecipient, address1: e.target.value })} />
                <Grid container spacing={2} sx={{ mb: 2 }}>
                  <Grid item xs={5}>
                    <TextField fullWidth label="City" size="small" value={editRecipient.city}
                      onChange={(e) => setEditRecipient({ ...editRecipient, city: e.target.value })} />
                  </Grid>
                  <Grid item xs={4}>
                    <FormControl fullWidth size="small">
                      <InputLabel>State</InputLabel>
                      <Select value={editRecipient.state} label="State"
                        onChange={(e) => setEditRecipient({ ...editRecipient, state: e.target.value })}>
                        {US_STATES.map(s => <MenuItem key={s} value={s}>{s}</MenuItem>)}
                      </Select>
                    </FormControl>
                  </Grid>
                  <Grid item xs={3}>
                    <TextField fullWidth label="ZIP" size="small" value={editRecipient.postalCode}
                      onChange={(e) => setEditRecipient({ ...editRecipient, postalCode: e.target.value })} />
                  </Grid>
                </Grid>
                <Box sx={{ display: 'flex', gap: 2 }}>
                  <Button variant="contained" onClick={submitEditedAddress}
                    disabled={!editRecipient.firstName || !editRecipient.address1 || !editRecipient.city || !editRecipient.state}
                    sx={{ borderRadius: 99, textTransform: 'none', fontWeight: 700, background: 'linear-gradient(135deg, #7c3aed, #db2777)', px: 3 }}>
                    Send to Checkout üì¶
                  </Button>
                  <Button variant="outlined" onClick={cancelAddressEdit}
                    sx={{ borderRadius: 99, textTransform: 'none', borderColor: '#7c3aed', color: '#7c3aed' }}>Cancel</Button>
                </Box>
              </Paper>
            )}

            {/* Recipient address badge */}
            {addressRequested && !showRecipientEdit && ecpStatus === 'active' && recipient && (
              <Paper sx={{ p: 2, mt: 2, display: 'flex', alignItems: 'center', gap: 1.5, bgcolor: '#f0fdf4', borderRadius: 3, border: '1px solid rgba(22,163,74,0.2)' }}>
                <Typography sx={{ fontSize: 20 }}>‚úÖ</Typography>
                <Typography variant="body2">
                  Shipping to: <strong>{recipient.firstName} {recipient.lastName}</strong> ‚Äî {recipient.address1}, {recipient.city}, {recipient.state} {recipient.postalCode}
                </Typography>
              </Paper>
            )}
          </DialogContent>
        </Dialog>
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
